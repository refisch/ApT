function [vali] = aptValidation(sequence, predNames, stats, numberSamples, modeSeqGen)
%APTVALIDATION estimates new candidates (which are generated by
%aptGenerateSequence) for given stats model.
%   'sequence' is cell array of previously analyzed aptameres
%   'predNames' predictor names of previously analyzed aptameres - needed
%   for sanity check
%   'stats' is struct from lasso regression
%   'numberSamples' is number of newly generated candidates
%   'modeSeqGen' is mode used for randomly generating new candidates.
    
if nargin <= 3
    error('function needs at least 3 inputs')
end

if(~exist('numberSamples','var') || isempty(numberSamples))
    numberSamples = 1000;
end

if(~exist('modeSeqGen','var') || isempty(modeSeqGen))
    modeSeqGen = 'random';
end

validationIndex = stats.Index1SE;

vali.number = numberSamples;
vali.beta = stats.beta(:,validationIndex);
vali.intercept = stats.Intercept(validationIndex);
vali.mode = modeSeqGen;
vali.sequence = aptGenerateSequence(sequence,vali.number,modeSeqGen);

[X, vali.PredictorNames] = aptPredictors(vali.sequence);

if sum(cellfun(@strcmp,vali.PredictorNames, predNames)) ~= length(vali.PredictorNames)
    error('validation predictors do not match calibrated predictors!')
end

vali.EstRates = vali.intercept + X'*vali.beta;

end

